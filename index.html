<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validador de CAF</title>
  <style>
    :root{
      --green:#2e7d32;
      --green-700:#1b5e20;
      --muted:#f5f5f5;
      --ink:#111;
      --panel:#fff;
      --wa:#25D366;
    }
    *{box-sizing:border-box}
    body{font-family: Arial, Helvetica, sans-serif; color:var(--ink); margin:0; background:#fff}
    .wrap{max-width:980px; margin:auto; padding:24px 20px 110px}

    h1{ color:var(--green); font-size:28px; margin:0 0 6px; font-weight:800 }
    .lead{ margin:0 0 14px; line-height:1.45; font-size:14px; color:#303030 }
    .lead code{font-weight:700; background:transparent; padding:0}
    code{ background:#eef7ee; padding:2px 6px; border-radius:6px; }

    /* barra de links como no print */
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 16px}
    .link-btn{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      border:1px solid var(--green); color:var(--green); background:transparent;
      border-radius:999px; padding:8px 14px; font-weight:600; font-size:14px;
    }
    .link-btn:hover{ background:var(--green); color:#fff }
    .link-btn svg{ width:18px; height:18px }

    .panel{ background:var(--panel); border:1px solid #e7e7e7; border-radius:14px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    input[type="text"]{
      flex:1 1 520px; min-width:260px; padding:10px 16px; font-size:14px;
      border:2px solid var(--green); border-radius:999px; outline:none; text-transform:uppercase;
    }
    input[type="text"]:focus{ border-color:var(--green-700) }
    button.primary{
      padding:10px 16px; background:var(--green); color:#fff;
      border:none; border-radius:999px; cursor:pointer; font-weight:700; font-size:14px;
    }
    button.primary:disabled{ opacity:.6; cursor:not-allowed }
    .hint{ font-size:12px; color:#555; margin-top:8px }

    .stats{ display:flex; gap:12px; align-items:center; margin:10px 0 0; font-size:13px; }
    .badge{
      display:inline-block; background:#eef7ee; color:var(--green);
      border:1px solid var(--green); border-radius:999px; padding:2px 8px; font-weight:700
    }
    .danger{ color:#b00020 }
    .ok{ color:var(--green) }

    .result{ margin-top:10px }
    .result .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .item{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:start;
      gap:12px;
      background:var(--muted);
      padding:10px 12px;
      border-radius:10px;
    }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:15px;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .actions{ display:flex; gap:8px; }
    .ghost{
      background:transparent; color:var(--green);
      border:1px solid var(--green); border-radius:999px;
      padding:6px 12px; cursor:pointer; font-weight:600; min-width:84px;
      display:inline-flex; align-items:center; justify-content:center; font-size:13px;
    }
    .ghost:hover{ background:var(--green); color:#fff }

    .footer-note{ font-size:11px; color:#666; margin:10px 2px }

    /* Bot√£o flutuante WhatsApp em p√≠lula (como no print) */
    .whatsapp-fab{
      position: fixed; right: 16px; bottom: 16px; z-index: 10000;
      display: inline-flex; align-items: center; gap: 10px;
      background: var(--wa); color: #fff; text-decoration: none;
      border-radius: 999px; padding: 10px 18px; font-weight: 800; font-size:14px;
      box-shadow: 0 8px 16px rgba(0,0,0,.18);
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .whatsapp-fab:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.22); filter: brightness(.97); }
    .wa-icon{
      width: 28px; height: 28px; border-radius: 999px; background: #fff;
      display: inline-flex; align-items: center; justify-content: center; flex: 0 0 28px;
    }
    .wa-icon svg{ width:18px; height:18px; color: var(--wa); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>VALIDADOR DE CAF</h1>

    <p class="lead">
      Digite o CAF com curingas (<code>*</code>) para gerar combina√ß√µes no servidor.
      Exemplo: <code>BA032025.01.00**39367CAF</code>
    </p>

    <!-- links exatamente como no print: dois bot√µes lado a lado -->
    <div class="toolbar">
      <a class="link-btn" href="https://drive.google.com/drive/folders/1T4eIs-TP56ZhTrQayJcFTsRPR1m6XUEj?usp=sharing" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        V√≠deo de Instru√ß√µes
      </a>
      <a class="link-btn" href="https://caf.mda.gov.br/consulta-publica/ufpa" target="_blank" rel="noopener">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.9 12a5 5 0 0 1 5-5h3v2h-3a3 3 0 0 0 0 6h3v2h-3a5 5 0 0 1-5-5Zm7-1h2v2h-2v-2Zm3.1-4h3a5 5 0 0 1 0 10h-3v-2h3a3 3 0 0 0 0-6h-3V7Z"/></svg>
        Site oficial de consulta do CAF
      </a>
    </div>

    <div class="panel">
      <div class="row">
        <input 
          id="inputCAF"
          type="text"
          placeholder="Ex.: BA032025.01.00**39367CAF"
          maxlength="24"
          pattern="^BA\d{6}\.\d{2}\.[0-9*]{9}CAF$"
          title="Formato v√°lido: BA032025.01.00**39367CAF"
        />
        <button id="btnGerar" class="primary">GERAR CAF</button>
      </div>
      <div class="hint">‚Ä¢ O sistema gera CAF criadas at√© setembro de 2025.</div>
      <div class="stats" id="stats"></div>
    </div>

    <div class="result" id="resultado"></div>

    <p class="footer-note">
      Clique na <b>lupa</b> para abrir a consulta com o CAF copiado. <b>Copiar</b> coloca o c√≥digo na √°rea de transfer√™ncia.
    </p>
  </div>

  <!-- Bot√£o flutuante do WhatsApp (padr√£o p√≠lula do print) -->
  <a
    class="whatsapp-fab"
    href="https://wa.me/5575999778739?text=Ol%C3%A1%2C%20solicito%20orienta%C3%A7%C3%A3o%20sobre%20o%20Site%20Validador%20da%20CAF"
    target="_blank" rel="noopener" aria-label="Suporte no WhatsApp" title="Suporte no WhatsApp">
    <span class="wa-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path fill="currentColor" d="M20.52 3.48A11 11 0 0 0 2.05 17.28L1 22l4.84-1.27A11 11 0 0 0 22 11a10.95 10.95 0 0 0-1.48-7.52ZM12 20.2a8.2 8.2 0 0 1-4.19-1.15l-.3-.18-2.96.78.79-2.88-.19-.3A8.2 8.2 0 1 1 20.2 12 8.2 8.2 0 0 1 12 20.2Zm4.6-6.15c-.25-.12-1.47-.73-1.7-.82s-.4-.12-.57.12-.65.82-.8 1-.3.2-.55.07a6.68 6.68 0 0 1-3.11-2.71c-.24-.41-.25-.76 0-1s.5-.57.62-.87.06-.52-.03-.73-.85-2.06-1.16-2.81-.61-.65-.84-.66h-.72a1.39 1.39 0 0 0-1 .47 3.32 3.32 0 0 0-1 2.44 5.78 5.78 0 0 0 1.22 3.06 13.2 13.2 0 0 0 5 4.72c.5.22.88.35 1.19.45.5.16.96.14 1.32.08a2.86 2.86 0 0 0 1.9-1.32 2.3 2.3 0 0 0 .16-1.35c-.07-.13-.22-.2-.47-.33Z"/>
      </svg>
    </span>
    Suporte no WhatsApp
  </a>

  <script>
    const input = document.getElementById('inputCAF');
    const btn = document.getElementById('btnGerar');
    const out = document.getElementById('resultado');
    const stats = document.getElementById('stats');

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style,{
        position:'fixed', right:'16px', bottom:'16px', background:'#333', color:'#fff',
        padding:'8px 12px', borderRadius:'10px', fontSize:'13px', opacity:'0',
        transition:'opacity .2s ease', zIndex:9999
      });
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity='1'; });
      setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),200); },1200);
    }

    function linhaCAF(code){
      const div = document.createElement('div');
      div.className = 'item';

      const left = document.createElement('div');
      left.className = 'code';
      left.textContent = code;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const btnCopy = document.createElement('button');
      btnCopy.className = 'ghost';
      btnCopy.textContent = 'Copiar';
      btnCopy.addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(code);
          toast('Copiado!');
        }catch(e){ alert('N√£o foi poss√≠vel copiar.'); }
      });

      const btnLupa = document.createElement('button');
      btnLupa.className = 'ghost';
      btnLupa.innerHTML = 'üîç';
      btnLupa.title = 'Abrir consulta do CAF';
      btnLupa.addEventListener('click', async () => {
        try{ await navigator.clipboard.writeText(code);}catch(_){}
        const url = 'https://caf.mda.gov.br/consulta-publica/ufpa?caf=' + encodeURIComponent(code);
        window.open(url,'_blank','noopener');
      });

      actions.append(btnCopy, btnLupa);
      div.append(left, actions);
      return div;
    }

    // restri√ß√£o suave de digita√ß√£o + limpar erros
    input.addEventListener('input', () => {
      const max = parseInt(input.getAttribute('maxlength'), 10) || 24;
      let v = (input.value || '').toUpperCase().replace(/[^A-Z0-9.*]/g, '');
      if (v.length > max) v = v.slice(0, max);
      input.value = v;
      input.setCustomValidity('');
    });

    // BAMMAAAA.XX.XXXXXXXXXCAF
    const CAF_REGEX = /^BA\d{6}\.\d{2}\.[0-9*]{9}CAF$/;

    async function gerar(){
      out.innerHTML = '';
      stats.textContent = 'Processando...';
      btn.disabled = true;

      const caf = (input.value || '').trim().toUpperCase();
      try{
        const resp = await fetch('/api/gerar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ caf })
        });
        const data = await resp.json();

        if(!resp.ok){
          stats.innerHTML = `<span class="badge danger">Erro</span> <span>${data.erro || 'Falha ao gerar.'}</span>`;
          return;
        }

        // remove duplicados preservando a ordem
        const unicos = Array.from(new Set(Array.isArray(data.combos) ? data.combos : []));
        stats.innerHTML = `<span class="badge ok">OK</span> <span>Geradas <b>${unicos.length.toLocaleString()}</b> combina√ß√µes.</span>`;

        const grid = document.createElement('div');
        grid.className = 'grid';
        for(const code of unicos){
          grid.appendChild(linhaCAF(code));
        }
        out.appendChild(grid);

      }catch(err){
        stats.innerHTML = `<span class="badge danger">Erro</span> <span>${err.message}</span>`;
      }finally{
        btn.disabled = false;
      }
    }

    // valida√ß√£o + submit
    btn.addEventListener('click', (e) => {
      const value = (input.value || '').toUpperCase().trim();
      if (!CAF_REGEX.test(value)) {
        e.preventDefault();
        input.setCustomValidity('Formato inv√°lido. Use ex: BA032025.01.00**39367CAF. Onde, ap√≥s o BA √© o m√™s e ano de inscri√ß√£o.');
        input.reportValidity();
        return;
      }
      input.setCustomValidity('');
      gerar();
    });

    // Enter submete
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btn.click();
      }
    });
  </script>
</body>
</html>
